+++
title = "Lab #5 ‚Äî Detecting Lateral Movement via RDP with Wazuh"
slug = "lab5-rdp-detection-wazuh"
date = "2025-11-09T16:30:00-05:00"
author = "RoninSec"
cover = "lab5-rdp-detection-banner.png"
tags = ["wazuh","sysmon","rdp","windows","detection-engineering","blue-team"]
keywords = ["Wazuh", "Sysmon", "RDP detection", "Event ID 1149", "Event ID 4624", "Event ID 3", "Wazuh rules", "detection engineering"]
description = "Build detection rules for RDP lateral movement using Windows Security, Sysmon, and RemoteConnectionManager logs. Includes working Wazuh XML rules and troubleshooting notes."
showFullContent = false
readingTime = true
hideComments = false
draft = false
+++

# Lab #5 ‚Äî Detecting Lateral Movement via RDP with Wazuh

This lab was straightforward on paper: RDP into a target machine where the Wazuh agent is running and locate the RDP connection within the logs.  
Basic detection engineering, right?  
Well‚Ä¶ it didn‚Äôt go quite that easily.

---

## üß± The Challenge

By default, you can find successful RDP logons in the Windows Security Log under:

- **Event ID 4624** ‚Äî *Microsoft-Windows-Security-Auditing* (successful logon)  
  - `LogonType = 10 ‚Üí RemoteInteractive`

That‚Äôs too easy though ‚Äî plus, I had Sysmon installed!  
So I also checked:

- **Event ID 1149** ‚Äî *Microsoft-Windows-TerminalServices-RemoteConnectionManager/Operational*  
- **Event ID 3** ‚Äî *Microsoft-Windows-Sysmon/Operational* (Network connection)

---

## ‚öôÔ∏è The Pain

I tried for almost two weeks to get Wazuh to alert based on Sysmon logs, and for most of that time, it refused to cooperate.  
Even after watching John Hammond‚Äôs video on Wazuh Detection Engineering and reading the documentation, I was hitting wall after wall ‚Äî mostly XML syntax errors and silent rule failures.

At one point, every rule generated by AI tools or the Grok debugger failed to parse correctly, so I typed the XML out manually (yes, really).

After revisiting the [Wazuh Rules documentation](https://documentation.wazuh.com/current/user-manual/ruleset/ruleset-xml-syntax/index.html) and [Decoders guide](https://documentation.wazuh.com/current/user-manual/ruleset/decoders.html), I realized something crucial:  
my rules weren‚Äôt nested correctly in the hierarchical rule chain.

---

## üß© Understanding the Hierarchy

Wazuh rules form a hierarchical chain:

1. **Lower-level base rules** classify the log (e.g., ‚Äúthis is a Windows event‚Äù).  
2. **Higher-level rules** refine that classification (e.g., ‚Äúthis is an RDP authentication event from that Windows log‚Äù).

Without the inline code block below, the rule parser didn‚Äôt know what family of logs it was dealing with, so it treated it as ‚Äúany machine.‚Äù  
Once I scoped the rule under the Windows group, everything started clicking.

```xml
<if_group>windows</if_group>
```
üí° The Working Rules

Here‚Äôs what finally worked:
```XML
<group name="windows,rdp,authentication,">
  <rule id="921149" level="6">
    <if_group>windows</if_group>
    <field name="win.system.channel">Microsoft-Windows-TerminalServices-RemoteConnectionManager/Operational</field>
    <field name="win.system.eventID">1149</field>
    <description>RDP: user authentication succeeded (1149)</description>
  </rule>
</group>

<group name="windows,rdp,authentication,">
  <rule id="921150" level="6">
    <if_group>windows</if_group>
    <field name="win.system.channel">Microsoft-Windows-Sysmon/Operational</field>
    <field name="win.system.eventID">3</field>
    <description>Sysmon RDP: user authentication succeeded (3)</description>
  </rule>
</group>
```
Once these rules were added to /var/ossec/etc/rules/ under the name rdp.xml and I restarted the Wazuh manager, all three sources began firing.
üöÄ Test Setup

I reverted my Elastic VM snapshot (which already had Sysmon installed and RDP enabled) and ran multiple RDP connections to simulate remote interactive logons.

After adding the rules above and restarting Wazuh, I successfully generated three detection events.
üì∏ Results

‚úÖ Event ID 1149 ‚Äî TerminalServices RemoteConnectionManager

{{< image src="TerminalServicesSuccess.png" alt="TerminalServicesSuccess" >}}

‚úÖ Event ID 3 ‚Äî Sysmon (Network Connection)

{{< image src="SysmonSuccess.png" alt="SysmonSuccess" >}}
{{< image src="SysmonSuccess2.png" alt="SysmonSuccess2" >}}

‚úÖ Event ID 4624 ‚Äî Windows Security Auditing

{{< image src="WindowsSecurityAuditing.png" alt="WindowsSecurityAuditing" >}}
{{< image src="WindowsSecurityAuditing2.png" alt="WindowsSecurityAuditing2" >}}
## üß† Lessons Learned

There are three reliable ways to detect successful RDP connections with Wazuh Detection Engineering:

    Event ID 4624 ‚Äî Windows Security Log (easy baseline)

    Event ID 1149 ‚Äî RemoteConnectionManager (RDP authentication)

    Event ID 3 ‚Äî Sysmon Network Connection (deeper telemetry)

What made this lab satisfying is not just the result but the process ‚Äî two weeks of debugging XML, verifying Sysmon output, and learning how Wazuh actually classifies events under the hood.
Once I grasped that hierarchical logic, the rest fell into place.

## üß≠ Summary
Detection Source	Log Channel	Event ID	Description
Microsoft-Windows-Security-Auditing	Security	4624	Successful logon (RemoteInteractive)
Microsoft-Windows-TerminalServices-RemoteConnectionManager	Operational	1149	RDP user authentication succeeded
Microsoft-Windows-Sysmon	Operational	3	Network connection (RDP session)

## üèÅ Takeaway

    ‚ÄúSometimes detection engineering isn‚Äôt about creating new rules ‚Äî it‚Äôs about understanding why your current ones don‚Äôt fire.‚Äù

After all that, I finally have working RDP detections across Sysmon, Windows Security, and RemoteConnectionManager ‚Äî and can move on to Lab #6: Detecting Privilege Escalation.
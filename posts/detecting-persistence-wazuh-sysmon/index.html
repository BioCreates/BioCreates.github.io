<!doctype html><html lang=en><head><title>Detecting Persistence with Wazuh + Sysmon :: RoninSec - Cyber Journal</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Simulate Windows persistence (schtasks / Run key), verify Sysmon logs, confirm Wazuh ingestion, and write a custom Wazuh rule to generate alerts."><meta name=keywords content="Wazuh,Sysmon,persistence detection,scheduled task,run key,custom rule"><meta name=robots content="noodp"><link rel=canonical href=https://BioCreates.github.io/posts/detecting-persistence-wazuh-sysmon/><link rel=stylesheet href=https://BioCreates.github.io/css/custom.min.2707a48b3c4cb7c495ff47581f9533e9f6f3ffeb9c1f0bb8ac2ba5ae94c0f96b.css><link rel=stylesheet href=https://BioCreates.github.io/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://BioCreates.github.io/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://BioCreates.github.io/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://BioCreates.github.io/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://BioCreates.github.io/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://BioCreates.github.io/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://BioCreates.github.io/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css><link rel=stylesheet href=https://BioCreates.github.io/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css><link rel=stylesheet href=https://BioCreates.github.io/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://BioCreates.github.io/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css><link rel=stylesheet href=https://BioCreates.github.io/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css><link rel=stylesheet href=https://BioCreates.github.io/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://BioCreates.github.io/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel=stylesheet href=https://BioCreates.github.io/terminal.css><link rel="shortcut icon" href=https://BioCreates.github.io/favicon.png><link rel=apple-touch-icon href=https://BioCreates.github.io/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Detecting Persistence with Wazuh + Sysmon"><meta property="og:description" content="Simulate Windows persistence (schtasks / Run key), verify Sysmon logs, confirm Wazuh ingestion, and write a custom Wazuh rule to generate alerts."><meta property="og:url" content="https://BioCreates.github.io/posts/detecting-persistence-wazuh-sysmon/"><meta property="og:site_name" content="RoninSec - Cyber Journal"><meta property="og:image" content="https://BioCreates.github.io/posts/detecting-persistence-wazuh-sysmon/persistence-wazuh-banner.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2025-10-15 21:00:00 -0400 -0400"><link rel=stylesheet href=/css/custom.min.2707a48b3c4cb7c495ff47581f9533e9f6f3ffeb9c1f0bb8ac2ba5ae94c0f96b.css integrity="sha256-JwekizxMt8SV/0dYH5Uz6fbz/+ucHwu4rCulrpTA+Ws="></head><body><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>RoninSec</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/about>About</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/about>About</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://BioCreates.github.io/posts/detecting-persistence-wazuh-sysmon/>Detecting Persistence with Wazuh + Sysmon</a></h1><div class=post-meta><time class=post-date>2025-10-15</time><span class=post-author>RoninSec</span><span class=post-reading-time>4 min read (650 words)</span></div><span class=post-tags>#<a href=https://BioCreates.github.io/tags/wazuh/>wazuh</a>&nbsp;
#<a href=https://BioCreates.github.io/tags/sysmon/>sysmon</a>&nbsp;
#<a href=https://BioCreates.github.io/tags/persistence/>persistence</a>&nbsp;
#<a href=https://BioCreates.github.io/tags/windows/>windows</a>&nbsp;
#<a href=https://BioCreates.github.io/tags/blue-team/>blue-team</a>&nbsp;
#<a href=https://BioCreates.github.io/tags/detection/>detection</a>&nbsp;
</span><img src=/posts/detecting-persistence-wazuh-sysmon/persistence-wazuh-banner.png class=post-cover alt="Detecting Persistence with Wazuh + Sysmon" title="Cover Image"><div class=post-content><div><p>In this lab, I explored how Wazuh detects Windows persistence techniques using Sysmon logs and custom rules. While Sysmon recorded every event perfectly, I learned that Wazuh doesn’t automatically alert unless a rule tells it to. Here’s how I found, fixed, and confirmed a missing detection.</p><p>I started by creating a scheduled task that launches calc.exe every few minutes to simulate persistence.
<img src=powershell1.png alt=powershell1 class=left></p><p>Confirmed they were seen by Sysmon
<img src=powershell2.png alt=powershell2 class=left></p><p>By searching &ldquo;sysmon&rdquo; I was able to narrow down the logs and then I narrowed it further between 10:30PM & 11PM and was able to find the event below.
<img src=regdetection.png alt=regdetection class=left></p><p>But in a real environment manually going through alerts is a nightmare so I used this query to find Sysmon alerts with Event ID 1 (Process creation):
data.win.system.providerName:&ldquo;Microsoft-Windows-Sysmon&rdquo; AND data.win.system.eventID:1</p><p>Then I quickly found this entry
Oct 14, 2025 @ 22:56:59.067
<img src=regdetection2.png alt=regdetection2 class=left></p><p>Expanding it shows more details like the exact cmd line
<img src=regdetectioncmd.png alt=regdetectioncmd class=left></p><p>side note, something I learned was that when setting creds via net user (which I did to set up RDP on the target machine) will show the password in cleartext in the sysmon event logs
<img src=netuser.png alt=netuser class=left></p><p>It does not show up in built in WindowsEventLogs unless you enable Advanced auditing by doing the following:</p><ol><li><code>Win + R</code> → <code>secpol.msc</code></li><li>Advanced Audit Policy Configuration → <strong>System Audit Policies</strong> → <strong>Detailed Tracking</strong></li><li>Double-click <strong>Audit Process Creation</strong> → check <strong>Success</strong> (and <strong>Failure</strong> if you want) → <strong>OK</strong>.</li></ol><p>I did not do the above, it was not in the scope of this particular post but we can circle back to it at a later date if needed.</p><p>Moving on&mldr;</p><h2 id=detecting-the-schtasks-task-creation-command>Detecting the schtasks task creation command<a href=#detecting-the-schtasks-task-creation-command class=hanchor arialabel=Anchor>#</a></h2><p>Went through the ringer a bit on this one.</p><p>So first I created the schtask</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>schtasks /create /sc minute /mo 50 /tn <span class=s2>&#34;TestTask&#34;</span> /tr <span class=s2>&#34;calc.exe&#34;</span>
</span></span></code></pre></div><p>Can confirm that the task was created and ID&rsquo;d by Sysmon logs Event ID 1</p><img src=sysmoneventid.png alt=sysmoneventid class=left><p>But it was not showing up in Wazuh AT ALL&mldr; I went through a ton of research to find out why but &mldr; the TLDR version of it is below</p><h3 id=-gotcha-moment--when-sysmon-events-go-missing-in-wazuh>🧩 Gotcha Moment — When Sysmon Events Go Missing in Wazuh<a href=#-gotcha-moment--when-sysmon-events-go-missing-in-wazuh class=hanchor arialabel=Anchor>#</a></h3><p>This one had me chasing ghosts. I could see the Sysmon event for <code>schtasks.exe</code> in Windows Event Viewer, but it never showed up in Wazuh. At first, I suspected a bad query — but the real issue was deeper: <strong>Wazuh doesn’t alert on events unless a rule explicitly tells it to.</strong></p><p>By default, Wazuh receives the raw Sysmon data but ignores anything without a matching rule. Since there was no rule for <code>schtasks.exe</code> process creation (Event ID 1), those events never made it into the Wazuh alerts index.</p><p>The fix was to add a <strong>custom rule</strong> inside the Wazuh Manager container at:
<code>/var/ossec/etc/rules/local_rules.xml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;group</span> <span class=na>name=</span><span class=s>&#34;windows,sysmon,persistence,&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;rule</span> <span class=na>id=</span><span class=s>&#34;100502&#34;</span> <span class=na>level=</span><span class=s>&#34;10&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;description&gt;</span>Sysmon ProcessCreate: schtasks.exe observed<span class=nt>&lt;/description&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;if_group&gt;</span>sysmon_event1<span class=nt>&lt;/if_group&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;match&gt;</span>\\schtasks.exe<span class=nt>&lt;/match&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/rule&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/group&gt;</span>
</span></span></code></pre></div><p>After saving the file and restarting Wazuh with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo docker <span class=nb>exec</span> -it single-node-wazuh.manager-1 /var/ossec/bin/wazuh-control restart
</span></span></code></pre></div><p>Then I ran the scheduled task creation command again</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>schtasks /create /sc minute /mo 50 /tn <span class=s2>&#34;TestTask&#34;</span> /tr <span class=s2>&#34;calc.exe&#34;</span>
</span></span></code></pre></div><p>Then&mldr;</p><p>BOOM!
<img src=success.png alt=success class=left></p><img src=success1.png alt=success1 class=left><p>I can now see it in Wazuh.</p><h2 id=-wrapping-it-up>🧩 Wrapping It Up<a href=#-wrapping-it-up class=hanchor arialabel=Anchor>#</a></h2><p>This lab was a good reminder that <strong>detection isn’t just about data collection — it’s about interpretation.</strong> Sysmon saw the event immediately, but Wazuh didn’t raise its hand until I told it what to look for. Once that rule was in place, everything clicked.</p><p>The takeaway is simple but critical:</p><blockquote><p>Wazuh won’t alert on what it doesn’t understand — if you want visibility, you have to teach it what matters. I guess that&rsquo;s why people LOVE tuning SIEMs and alert tools.</p></blockquote><p>So if you’re building detections, don’t stop at collecting logs. Always verify that your rules actually <em>fire</em> the way you expect. Even the best telemetry means nothing without context.</p><p>“With custom rules firing properly, Wazuh is now ready for deeper endpoint detection tests — next, I’ll simulate privilege escalation and lateral movement to see how Wazuh responds.”</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><a href=https://BioCreates.github.io/posts/procmon-printing-freeze/ class="button inline next">[<span class=button__text>Using ProcMon to Troubleshoot Printing Freezes in Word</span>] ></a></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>